(function(){const A="storage";const B="array";const E="mui_default";function C(G){this.source=G.source;if(!this.source&&!G.name){throw new Error("Either source or name must be specified to uniquely identify the datasource");}this.name=G.name;if(G.onRestore){this.onRestore=G.onRestore;}if(G.cache){this.cache={};this.cache.id=G.cache.id||"mui_datacache_"+(this.source||this.name);this.cache.version=G.cache.version||"";this.cache.title=G.cache.title||"";this.cache.max=G.cache.max||10;this.cache.keepalive=G.cache.keepalive||{minutes:30};this.cache.type=(mui.Storage)?A:B;this.cache.contents=[];this.restored=true;if(this.cache.type===A){try{this.restored=false;this.cache.tableName=this.source?this.source.replace(/[\?\:\\\/\*\>\<\|\.\%\&\"]+/g,"_"):"mui_table_"+this.name;this.restoreCache();}catch(H){this.cache.storage=null;this.cache.type=B;setTimeout(mui.bind(this.onRestore,this),0);}}else{setTimeout(mui.bind(this.onRestore,this),0);}}}function F(H,I){var G=H||"";if(I){if(G!=""&&!/\?/.test(G)){G+="?";}G+=I;}return G;}function D(K,I){var G=false,H=K,J=+(new Date);mui.iterate(I,function(L,M){switch(M){case"days":H+=86400*L*1000;break;case"hours":H+=3600*L*1000;break;case"minutes":H+=60*L*1000;break;case"seconds":H+=L*1000;break;}});if(J>H){G=true;}return G;}C.prototype={onRestore:function(){},sendRequest:function(H,I){var G=this.getCachedEntry(H);if(G){I.success.apply(I.scope||I.success,[G.response,I.argument]);return;}mui.io(F(this.source,H),{callback:{success:function(J){this.onSendSuccess(H,J.responseText);I.success.apply(I.scope||I.success,[J.responseText,I.argument]);},failure:function(J){this.onSendFailure(J);if(I.failure){I.failure.apply(I.scope||I.failure,[J,I.argument]);}},scope:this}});},onSendSuccess:function(H,G){if(this.cache){this.addToCache(H,G);}},onSendFailure:function(G){},addToCache:function(J,H){J=J||E;var I=[];var G={request:J,response:H,timestamp:+(new Date)};while(this.cache.contents.length>=this.cache.max){I.push(this.cache.contents.shift());}this.cache.contents.push(G);if(this.cache.storage){this.cache.storage.transaction(mui.bind(function(K){if(I.length>0){mui.each(I,function(L){K.executeSql("DELETE FROM "+this.cache.tableName+" WHERE request = ?",[L.request]);},this);}K.executeSql("INSERT INTO "+this.cache.tableName+" (request, response, timestamp) VALUES(?, ?, ?)",[G.request,G.response,G.timestamp]);},this));}},getCachedEntry:function(J){var I,H=0,G=this.cache.contents.length,K;J=J||E;for(H;H<G;H++){K=this.cache.contents[H];if(K.request===J&&!D(K.timestamp,this.cache.keepalive)){I=K;break;}}return I;},getCache:function(){return this.cache.contents;},flushCache:function(){this.cache.contents=[];if(this.cache.storage){this.cache.storage.transaction(mui.bind(function(G){G.executeSql("DROP TABLE "+this.cache.tableName,[],mui.bind(this.restoreCache,this));},this));}},restoreCache:function(){var G=this;this.cache.contents=[];this.cache.storage=mui.Storage.open(this.cache.id,this.cache.version,this.cache.title);this.cache.storage.transaction(mui.bind(function(H){H.executeSql("CREATE TABLE IF NOT EXISTS "+this.cache.tableName+" (request VARCHAR(32) PRIMARY KEY, response TEXT, timestamp INT)",[],mui.bind(function(I){I.executeSql("SELECT * FROM "+this.cache.tableName,[],mui.bind(function(K,L){if(L&&L.rows&&L.rows.length>0){for(var M=0,J=L.rows.length;M<J;M++){if(!D(L.rows.item(M).timestamp,this.cache.keepalive)){this.cache.contents.push(L.rows.item(M));}else{K.executeSql("DELETE FROM "+this.cache.tableName+" WHERE request = ?",[L.rows.item(M).request]);}}}this.restored=true;this.onRestore();},this));},this));},this));}};mui.DataSource=C;})();